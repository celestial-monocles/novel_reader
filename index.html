<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Novel Chapter Reader</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root {
    --bg-light: #f4f4f4;
    --text-light: #333;
    --bg-dark: #121212;
    --text-dark: #eee;
	--select-bg-dark: #333;
	--select-text-dark: #eee;
  }

  body {
    font-family: Arial, sans-serif;
    background: var(--bg-light);
    color: var(--text-light);
    margin: 0;
    padding: 0;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  body.dark {
    background: var(--bg-dark);
    color: var(--text-dark);
  }

  #controls {
    background: #fff;
    padding: 10px;
    border-bottom: 1px solid #ccc;
    position: sticky;
    top: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    z-index: 10;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  body.dark #controls {
    background: #222;
    border-color: #444;
  }

  #controls input[type=file],
  #controls select,
  #controls button,
  #controls label {
    font-size: 16px;
    padding: 8px;
    background: inherit;
    border: 1px solid #ccc;
    border-radius: 4px;
    color: inherit;
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    cursor: pointer;
  }
  
  body.dark #controls select {
    background-color: var(--select-bg-dark);
    color: var(--select-text-dark);
  }
  
  /* Style the dropdown options in dark mode */
  body.dark #controls select option {
    background: var(--select-bg-dark);
    color: var(--select-text-dark);
  }

  body.dark #controls input[type=file],
  body.dark #controls select,
  body.dark #controls button,
  body.dark #controls label {
    border-color: #666;
  }

  #textSizeWrapper {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #textSizeWrapper button {
    padding: 6px 10px;
    font-size: 16px;
    cursor: pointer;
    background: inherit;
    border: 1px solid #ccc;
    border-radius: 4px;
    color: inherit;
  }

  #textSizeDisplay {
    min-width: 35px;
    text-align: center;
    font-size: 16px;
  }

  #chapter-content {
    max-width: 900px;
    margin: auto;
    padding: 15px;
    background: #fff;
    white-space: pre-wrap;
    line-height: 1.6;
    font-size: 1rem;
    min-height: 300px;
    transition: background-color 0.3s ease, color 0.3s ease, font-family 0.3s ease, font-size 0.3s ease;
  }

  body.dark #chapter-content {
    background: #1e1e1e;
    color: var(--text-dark);
  }

  #copyBtn {
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: #007bff;
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: background-color 0.3s ease;
  }
  #copyBtn:hover {
    background: #0056b3;
  }

  #copyTooltip {
    position: fixed;
    bottom: 85px;
    right: 35px;
    background: #333;
    color: #fff;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1001;
  }
  #copyTooltip.show {
    opacity: 1;
    pointer-events: auto;
  }

  #modeToggleBtn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    font-size: 20px;
    border: none;
    background: transparent;
    cursor: pointer;
    color: inherit;
    transition: transform 0.3s ease;
  }

  #modeToggleBtn:hover {
    transform: scale(1.1);
  }

  .dark #modeToggleBtn .sun {
    display: none;
  }

  .dark #modeToggleBtn .moon {
    display: block;
  }

  #modeToggleBtn .moon {
    display: none;
  }

  #modeToggleBtn .sun {
    display: block;
  }

  #appearanceControls {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-top: 1px solid #ccc;
    transition: all 0.3s ease;
    max-height: 100px;
    overflow: hidden;
  }

  #appearanceControls.collapsed {
    max-height: 0;
    padding: 0;
    border-top: none;
    opacity: 0;
  }

  /* Desktop Layout */
  #fileInput {
    min-width: 120px;
    max-width: 300px;
    margin-right: auto;
  }

  #nav-center {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex: 1;
  }

  #chapterSelect {
    min-width: 300px;
    max-width: 350px;
  }

  #prevBtn, #nextBtn {
    min-width: 100px;
    max-width: 120px;
  }

  #toggleAppearanceBtn {
    width: 180px;
    padding: 8px;
    background: inherit;
    border: 1px solid #ccc;
    border-radius: 4px;
    color: inherit;
    cursor: pointer;
    text-align: center;
    margin-left: auto;
  }

  body.dark #toggleAppearanceBtn {
    border-color: #666;
  }

  /* Mobile Layout */
  @media (max-width: 600px) {
    #controls {
      flex-direction: column;
      gap: 10px;
      padding: 10px;
    }

    #fileInput, #chapterSelect {
      width: 100%;
      max-width: none;
      box-sizing: border-box;
    }

    #fileInput {
      margin-right: 0;
    }

    #nav-center {
      width: 100%;
      flex-direction: column;
      gap: 10px;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    #prevBtn, #nextBtn {
      flex: 1;
      width: 100%;
      max-width: none;
    }

    #toggleAppearanceBtn {
      width: 100%;
      max-width: 180px;
      margin: 10px auto 0 auto;
    }

    #appearanceControls {
      flex-direction: column;
    }

    #appearanceControls > * {
      width: 100%;
    }

    #textSizeWrapper {
      justify-content: space-between;
    }
  }
</style>
</head>
<body>

<div id="controls">
  <input type="file" id="fileInput" accept=".txt,.docx" />
  
  <div id="nav-center">
    <select id="chapterSelect" title="Select Chapter"></select>
    <div class="nav-buttons">
      <button id="prevBtn" title="Previous Chapter">Previous</button>
      <button id="nextBtn" title="Next Chapter">Next</button>
    </div>
  </div>

  <button id="toggleAppearanceBtn">Settings ‚ñº</button>

  <div id="appearanceControls" class="collapsed">
    <button id="modeToggleBtn" title="Toggle Dark Mode">
      <span class="sun">‚òÄÔ∏è</span>
      <span class="moon">üåô</span>
    </button>

    <div id="textSizeWrapper">
      <button id="decreaseTextSize" type="button" aria-label="Decrease text size">A‚àí</button>
      <span id="textSizeDisplay" aria-live="polite">16px</span>
      <button id="increaseTextSize" type="button" aria-label="Increase text size">A+</button>
    </div>

    <select id="fontFamilySelect" title="Select Font Family">
      <option value="Arial, sans-serif" selected>Arial</option>
      <option value="Georgia, serif">Georgia</option>
      <option value="'Courier New', monospace">Courier New</option>
      <option value="'Times New Roman', serif">Times New Roman</option>
      <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
    </select>
  </div>
</div>

<div id="chapter-content">
  <em>Load a .txt or .docx file to begin.</em>
</div>

<button id="copyBtn" title="Copy chapter text">üìã</button>
<div id="copyTooltip">Copied!</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
<script>
  let chapters = [];
  let currentIndex = 0;

  const fileInput = document.getElementById("fileInput");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const chapterSelect = document.getElementById("chapterSelect");
  const chapterContent = document.getElementById("chapter-content");
  const copyBtn = document.getElementById("copyBtn");
  const copyTooltip = document.getElementById("copyTooltip");

  const modeToggleBtn = document.getElementById("modeToggleBtn");
  const fontFamilySelect = document.getElementById("fontFamilySelect");
  const toggleAppearanceBtn = document.getElementById("toggleAppearanceBtn");
  const appearanceControls = document.getElementById("appearanceControls");

  const decreaseTextSizeBtn = document.getElementById("decreaseTextSize");
  const increaseTextSizeBtn = document.getElementById("increaseTextSize");
  const textSizeDisplay = document.getElementById("textSizeDisplay");

  // Initial font size in pixels
  let currentFontSize = 16;
  const minFontSize = 12;
  const maxFontSize = 36;

  fileInput.addEventListener("change", handleFile);
  prevBtn.addEventListener("click", prevChapter);
  nextBtn.addEventListener("click", nextChapter);
  chapterSelect.addEventListener("change", (e) => {
    currentIndex = parseInt(e.target.value, 10);
    renderChapter();
  });
  copyBtn.addEventListener("click", copyChapterText);

  modeToggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    // Save preference to localStorage
    localStorage.setItem('darkMode', document.body.classList.contains('dark'));
  });

  fontFamilySelect.addEventListener("change", () => {
    chapterContent.style.fontFamily = fontFamilySelect.value;
  });

  decreaseTextSizeBtn.addEventListener("click", () => {
    if (currentFontSize > minFontSize) {
      currentFontSize--;
      updateFontSize();
    }
  });

  increaseTextSizeBtn.addEventListener("click", () => {
    if (currentFontSize < maxFontSize) {
      currentFontSize++;
      updateFontSize();
    }
  });

  toggleAppearanceBtn.addEventListener("click", () => {
    appearanceControls.classList.toggle("collapsed");
    const isCollapsed = appearanceControls.classList.contains("collapsed");
    toggleAppearanceBtn.textContent = isCollapsed ? 
      'Settings ‚ñº' : 'Settings ‚ñ≤';
  });

  function updateFontSize() {
    chapterContent.style.fontSize = currentFontSize + "px";
    textSizeDisplay.textContent = currentFontSize + "px";
  }

  function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const ext = file.name.split(".").pop().toLowerCase();
    if (ext === "txt") {
      const reader = new FileReader();
      reader.onload = () => processText(reader.result);
      reader.readAsText(file);
    } else if (ext === "docx") {
      const reader = new FileReader();
      reader.onload = (ev) => {
        mammoth
          .extractRawText({ arrayBuffer: ev.target.result })
          .then((result) => processText(result.value))
          .catch((err) => alert("Error reading .docx: " + err));
      };
      reader.readAsArrayBuffer(file);
    } else {
      alert("Unsupported file type. Use .txt or .docx");
    }
  }

  function processText(text) {
    text = text.replace(/\r\n/g, '\n');
    const chapterPattern = /^\s*(Ï†ú\s*\d+\s*Ìôî|\d+\s*Ìôî|Chapter\s+\d+|Episode\s+\d+)(\s|\.|$)/gmi;
    const chapterPositions = [];
    let match;
    while ((match = chapterPattern.exec(text)) !== null) {
        if (match.index === 0 || text[match.index-1] === '\n') {
            chapterPositions.push(match.index);
        }
    }

    if (chapterPositions.length > 0) {
        chapters = [];
        if (chapterPositions[0] > 0) {
            chapters.push(text.substring(0, chapterPositions[0]).trim());
        }
        
        for (let i = 0; i < chapterPositions.length; i++) {
            const start = chapterPositions[i];
            const end = (i < chapterPositions.length - 1) ? chapterPositions[i + 1] : text.length;
            const chapterText = text.substring(start, end).trim();
            if (chapterText) {
                chapters.push(chapterText);
            }
        }
    } else {
        chapters = [text];
    }
    
    populateDropdown();
    currentIndex = 0;
    renderChapter();
  }

  function populateDropdown() {
    chapterSelect.innerHTML = "";
    chapters.forEach((ch, i) => {
        const firstLine = ch.split('\n')[0].trim();
        let title = firstLine || `Chapter ${i + 1}`;
        title = title.trim();
        if (title.length > 50) {
            title = title.substring(0, 47) + '...';
        }
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = title;
        chapterSelect.appendChild(opt);
    });
  }

  function renderChapter() {
    chapterContent.textContent = chapters[currentIndex];
    chapterSelect.value = currentIndex;
    window.scrollTo(0, 0);
  }

  function prevChapter() {
    if (currentIndex > 0) {
      currentIndex--;
      renderChapter();
    }
  }

  function nextChapter() {
    if (currentIndex < chapters.length - 1) {
      currentIndex++;
      renderChapter();
    }
  }

  function copyChapterText() {
    if (!chapters.length) return;
    navigator.clipboard.writeText(chapters[currentIndex]).then(() => {
      showTooltip();
    }).catch(() => {
      alert("Copy failed. Try again.");
    });
  }

  function showTooltip() {
    copyTooltip.classList.add("show");
    setTimeout(() => {
      copyTooltip.classList.remove("show");
    }, 1500);
  }

  window.addEventListener("load", () => {
    updateFontSize();
    fontFamilySelect.dispatchEvent(new Event("change"));
    
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }
  });
</script>
</body>
</html>
